# Gryffine

Система мониторинга и аудита попыток логина в ОС Linux (серверная часть)

## Возможности
* Отслеживание и логирование попыток входа в систему в реальном времени
* Определение уровня потенциальной опасности по заранее установленным правилам
* Уведомление о логине в Telegram и по e-mail
* Экспорт логов в популярных форматах (csv, xls)
* Поиск по логам и фильтрация

## Как это работает
На клиентских машинах устанавливается [PAM-скрипт](https://github.com/PressXToWin/gryffine-client), который при попытке входа в систему отправляет json с информацией о входе на API-эндпоинт сервера. При этом абсолютно неважно через какой интерфейс осуществляется логин, будь это локальный вход в систему, вход через ssh или команды sudo/su. Далее, в случае удалённого входа не из локальных диапазонов, по IP-адресу устанавливается из какой страны осуществляется попытка входа (для этого используется сервис ipapi.co). После этого, проводится проверка по заранее установленным правилам (whitelist/blacklist) и в зависимости от результата устанавливается либо не устанавливается статус подозрительного входа.

## Интерфейс
![](docs/webinterface.png?raw=true)

Записи логов имеют цветовую дифференциацию. В случае, если успешный логин попадает под правила блэклиста, запись помечается красным цветом, в случае попадания под правила из вайтлиста, либо если логин происходит с локальных IP - зелёным. Логины, не попадающие ни под одно из правил помечаются жёлтым. Неуспешные логины отображаются серым цветом, вне зависимости от наличия в блэк/вайтлисте.

Есть возможность настроить уведомления через Telegram-бота и через e-mail.

![](docs/tg.png?raw=true)

![](docs/email.png?raw=true)

## Установка
Клонируем репозиторий

```git clone https://github.com/PressXToWin/gryffine-server.git```

Создаём виртуальное окружение и устанавливаем зависимости

```
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

Копируем файл gryffine/gryffine/.env.example в gryffine/gryffine/.env и устанавливаем в нём переменные окружения

```cp gryffine/gryffine/.env.example gryffine/gryffine/.env```

Создаём и применяем миграции

```python3 manage.py makemigrations```

```python3 manage.py migrate```

Создаём суперпользователя

```python3 manage.py createsuperuser```

Запускаем сервер

```python3 manage.py runserver```

Веб-интерфейс становится доступен по адресу http://127.0.0.1:8000/

## Настройка правил и уведомлений
Правила и уведомления настраиваются в админ-панели по адресу http://127.0.0.1:8000/admin/

Возможно задавать правила либо по стране происхождения IP, либо по маске подсети.
![](docs/rules.png?raw=true)

Уведомления настраиваются при редактировании пользователя. В случае, если нужны уведомления в Telegram, нужно прописать Telegram ID в профиле, то же самое касается и e-mail.
![](docs/notify.png?raw=true)

## API
Эндпоинт ```http://127.0.0.1:8000/api/v1/records/``` принимает POST-запросы в формате
```
{
    "service": "",          # сервис, через который происходит попытка входа в систему
    "user": "",             # логин пользователя
    "hostname": "",         # хостнейм машины, на которую производится логин
    "rhost": "",            # IP, с которого выполняется запрос, может быть пустым
    "is_successful": false  # является ли попытка успешной
}
```

## TODO
Система полностью функциональна, однако нужно запаковать в docker-контейнер.
