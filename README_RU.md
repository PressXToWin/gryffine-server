# Gryffine

Система мониторинга и аудита попыток логина в *nix-like OS (серверная часть)

## Возможности
* Отслеживание и логирование попыток входа в систему в реальном времени
* Определение уровня потенциальной опасности по заранее установленным правилам
* Уведомление о логине в Telegram и по e-mail
* Экспорт логов в популярных форматах (csv, xls)
* Поиск по логам и фильтрация

## Как это работает
На клиентских машинах устанавливается [PAM-скрипт](https://github.com/PressXToWin/gryffine-client), который при попытке входа в систему отправляет json с информацией о входе на API-эндпоинт сервера. При этом абсолютно неважно через какой интерфейс осуществляется логин, будь это локальный вход в систему, вход через ssh или команды sudo/su. Далее, в случае удалённого входа не из локальных диапазонов, по IP-адресу устанавливается из какой страны осуществляется попытка входа (для этого используется база [MaxMind's GeoLite2](https://dev.maxmind.com/geoip/geoip2/geolite2/)). После этого, проводится проверка по заранее установленным правилам (whitelist/blacklist) и в зависимости от результата устанавливается либо не устанавливается статус подозрительного входа.

## Интерфейс
![](docs/webinterface.png?raw=true)

Записи логов имеют цветовую дифференциацию. В случае, если успешный логин попадает под правила блэклиста, запись помечается красным цветом, в случае попадания под правила из вайтлиста, либо если логин происходит с локальных IP - зелёным. Логины, не попадающие ни под одно из правил помечаются жёлтым. Неуспешные логины отображаются серым цветом, вне зависимости от наличия в блэк/вайтлисте.

Есть возможность настроить уведомления через Telegram-бота и через e-mail.

![](docs/tg.png?raw=true)

![](docs/email.png?raw=true)

## Установка

 - Склонируйте репозиторий на сервер. 

```git clone https://github.com/PressXToWin/gryffine-server.git```

 - Переименуйте файл .env.example в .env и заполните его.
 - Создайте и запустите контейнеры Docker, выполнив команду на сервере:
```
docker compose up -d
```
 - После успешной сборки создать суперпользователя:
```
docker compose exec backend python manage.py createsuperuser
```

Сервер доступен по адресу http://127.0.0.1:8080/

## Настройка правил и уведомлений
Правила и уведомления настраиваются в админ-панели по адресу http://127.0.0.1:8080/admin/

Возможно задавать правила либо по стране происхождения IP, либо по маске подсети.
![](docs/rules.png?raw=true)

Уведомления настраиваются при редактировании пользователя. В случае, если нужны уведомления в Telegram, нужно прописать Telegram ID в профиле, то же самое касается и e-mail.
![](docs/notify.png?raw=true)

## API
Эндпоинт ```http://127.0.0.1:8080/api/v1/records/``` принимает POST-запросы в формате
```
{
    "service": "",          # сервис, через который происходит попытка входа в систему
    "user": "",             # логин пользователя
    "hostname": "",         # хостнейм машины, на которую производится логин
    "rhost": "",            # IP, с которого выполняется запрос, может быть пустым
    "is_successful": false  # является ли попытка успешной
}
```

## LICENSE

[MIT Licensed](https://github.com/PressXToWin/gryffine-server/blob/main/LICENSE)

This product includes GeoLite2 data created by MaxMind, available from [maxmind.com](https://www.maxmind.com).

